name: Sync Firmware from FPVGate

on:
  # Run when manually triggered
  workflow_dispatch:
  # Run daily to check for new releases
  schedule:
    - cron: '0 0 * * *'
  # Can be triggered by repository_dispatch from FPVGate repo
  repository_dispatch:
    types: [new-release]

jobs:
  sync-firmware:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout website repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch latest FPVGate release
        id: get_release
        run: |
          # Get latest release info
          RELEASE_DATA=$(curl -s https://api.github.com/repos/LouisHitchcock/FPVGate/releases/latest)
          
          # Extract version
          VERSION=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "Found release: $VERSION"
          
          # Save all assets for later processing
          echo "$RELEASE_DATA" | jq -r '.assets[] | "\(.name)|\(.browser_download_url)"' > /tmp/assets.txt
          cat /tmp/assets.txt
      
      - name: Check if version already exists
        id: check_version
        run: |
          VERSION="${{ steps.get_release.outputs.version }}"
          if [ -d "firmware/$VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version $VERSION already exists, skipping download"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version $VERSION is new, will download"
          fi
      
      - name: Download firmware binaries
        if: steps.check_version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_release.outputs.version }}"
          mkdir -p "firmware/$VERSION/boards"
          
          # Board configurations with their prefixes
          BOARDS=("ESP32S3-8MB" "ESP32S3-SuperMini-4MB" "LilyGO-T-Energy-S3" "ESP32C3")
          
          # Download board-specific binaries
          for BOARD in "${BOARDS[@]}"; do
            echo "Downloading binaries for $BOARD..."
            mkdir -p "firmware/$VERSION/boards/$BOARD"
            
            # Download each binary type
            while IFS='|' read -r NAME URL; do
              if [[ "$NAME" == "$BOARD-"* ]]; then
                FILENAME=$(echo "$NAME" | sed "s/${BOARD}-//")
                echo "  Downloading $FILENAME..."
                curl -L -o "firmware/$VERSION/boards/$BOARD/$FILENAME" "$URL"
              fi
            done < /tmp/assets.txt
          done
          
          # Also download README and sd_card_contents if present
          while IFS='|' read -r NAME URL; do
            if [[ "$NAME" == "README.txt" ]] || [[ "$NAME" == "sd_card_contents.zip" ]]; then
              echo "Downloading $NAME..."
              curl -L -o "firmware/$VERSION/$NAME" "$URL"
            fi
          done < /tmp/assets.txt
          
          echo "Downloaded all binaries for $VERSION"
          find "firmware/$VERSION" -type f -exec ls -lh {} \;
      
      - name: Update latest symlink
        if: steps.check_version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_release.outputs.version }}"
          
          # Create a versions.json file to track available versions
          if [ ! -f "firmware/versions.json" ]; then
            echo '{"versions": []}' > firmware/versions.json
          fi
          
          # Add this version to versions.json if not already there
          VERSIONS=$(cat firmware/versions.json)
          if ! echo "$VERSIONS" | jq -e ".versions[] | select(. == \"$VERSION\")" > /dev/null; then
            echo "$VERSIONS" | jq ".versions += [\"$VERSION\"] | .versions |= sort_by(.) | reverse" > firmware/versions.json
            echo "Added $VERSION to versions.json"
          fi
          
          # Update latest.json to point to this version
          echo "{\"latest\": \"$VERSION\"}" > firmware/latest.json
          
          cat firmware/versions.json
          cat firmware/latest.json
      
      - name: Commit and push changes
        if: steps.check_version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_release.outputs.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add firmware/
          git commit -m "Add firmware binaries for $VERSION"
          git push
          
          echo "Successfully synced firmware $VERSION"
